var zmNotifications=new (function(){var m=5000,E={nt:-1,fr:-1,pm:-1},D,c=0,y=-1,g=-1,G=new Array(),A=new Array(),j=null,C=false,z=zmConfig.BASE_URL,h={nt:"Bạn không có lời nhắn nào mới",fr:"Bạn không có lời mời kết bạn nào mới",pm:"Bạn không có tin nhắn nào mới"},n={nt:z+"apps/notify?fromid=0&count=30&type=3&masterpage=3",pm:z+"apps/msg",fr:z+"apps/invite"},e="Có lỗi xảy ra, vui lòng thử lại sau.",q={group:"zmcog.notifications",position:"fixed"};function b(I,H){zm("#"+I+"list").html(H);zwg.fillWg();if(I=="nt"){zm("#ntlist").children().hover(function(){if(zmNotifications.eDelayedShowFeed==this){return}if(zmNotifications.idDelayedShowFeed){clearTimeout(zmNotifications.idDelayedShowFeed)}var J=zm(this).attr("rel");if(J){var K=J.split(","),N=this;if(K.length>=2){zmNotifications.eDelayedShowFeed=this;zmNotifications.idDelayedShowFeed=setTimeout(function(){zmNotifications.idDelayedShowFeed=false;zmNotifications.eShowingFeed=this;switch(K[0]){case"photo":pnf.showPhoto(N,parseInt(K[2]),parseInt(K[4]),K[3],q);break;default:zmfw.showFeed(N,parseInt(K[0]),q);break}},800)}}else{var M=zm(this).attr("gift"),N=this;if(M){var L=M.split(",");if(L.length>=3){zmNotifications.eDelayedShowFeed=this;zmNotifications.idDelayedShowFeed=setTimeout(function(){zmNotifications.idDelayedShowFeed=false;zmNotifications.eShowingFeed=this;zmGift.showGift(N,parseInt(L[2]),parseInt(L[1]),L[3],q)},800)}}}},function(){if(zmNotifications.eDelayedShowFeed==this&&zmNotifications.idDelayedShowFeed){clearTimeout(zmNotifications.idDelayedShowFeed);zmNotifications.eDelayedShowFeed=false;zmNotifications.idDelayedShowFeed=false}}).click(function(){if(zmNotifications.idDelayedShowFeed){clearTimeout(zmNotifications.idDelayedShowFeed);zmNotifications.idDelayedShowFeed=false}var P=this;if(!zm(P).hasClass("zme_notify")){var O=zm(P).parents();for(var M=0;M<O.size();M++){if(O.get(M).hasClass("zme_notify")){P=O[M];break}}}var J=zm(P).attr("rel");if(J){var K=J.split(",");if(K.length>=2){zmNotifications.eDelayedShowFeed=P;zmNotifications.eShowingFeed=P;switch(K[0]){case"photo":pnf.showPhoto(P,parseInt(K[2]),parseInt(K[4]),K[3],q);break;default:zmfw.showFeed(P,parseInt(K[0]),q);break}}}else{var N=zm(P).attr("gift");if(N){var L=N.split(",");if(L.length>=3){zmNotifications.eDelayedShowFeed=P;zmNotifications.eShowingFeed=P;zmGift.showGift(P,parseInt(L[2]),parseInt(L[1]),L[3],q)}}}})}}function o(H){if(!H){H='<p class="notif_noitem">'+h.nt+"</p>"}else{if(H.err!=undefined&&H.err!=0){H='<p class="notif_noitem">'+e+"</p>"}}H+='<div class="zme-notify-bottom">			<a class="btn_L3 fr" href="#" onclick="zmNotifications.toggle(\'nt\'); return false;"><em>Đóng</em></a>			<p class="notif_bot_left fl">				<a href="'+n.nt+'">Xem tất cả</a>			</p>		</div>';return H}function x(O){var I="",L=O.total,M=O.data;if(O.err!=undefined&&O.err!=0){I='<p class="notif_noitem">'+e+"</p>"}else{if(M.length==0){I='<p class="notif_noitem">'+h.pm+"</p>"}else{if(L>0){zm("#pmpopup-title").html("Tin nhắn ("+L+")")}else{zm("#pmpopup-title").html("Tin nhắn")}for(var H=0,K;K=M[H];H++){var J="pma_"+H,N="pmd_"+H;I+='<div class="zme_notify" onclick="window.location.href=\''+z+"apps/msg?params=/view?id="+K.threadId+'\'" >					<span id="'+J+'" class="img" ></span>					<div class="zme-notify-item-cont">						<p><span id="'+N+'" class="zme-notify-fr-name"style="font-weight:bold"></span></p>						<p class="pmtxt">'+K.shortContent+'</p>						<p class="zme-notify-time"><span class="notificon icn_msg12x12"></span>'+zm.formatDateTime(K.time)+'</p>					</div>					<div class="clr"></div>				</div>';zwg.addItem(J,"ZMEA_"+K.senderId+"?id=1&l=0&size=42&width=42&height=42");zwg.addItem(N,"ZMED_"+K.senderId+"?id=1&l=0")}}}I+='<div class="zme-notify-bottom">			<a href="#" class="btn_L3 fr" onclick="zmNotifications.toggle(\'pm\'); return false;"><em>Đóng</em></a>			<p class="notif_bot_left fl">				<strong class="lk_bullet">.</strong>				<a href="'+n.pm+'" id="frViewAll">Xem tất cả</a>				<strong class="lk_bullet">.</strong>				<a href="/apps/msg?src=rdmsg" id="frInviteLink">Gửi tin nhắn mới</a>			</p>		</div>';return I}function k(){zm.getJSON(zmConfig.ZMSG_URL+"/inboxnotice",function(H){if(H.err==0&&H.data.length<7){setTimeout(function(){zm.getJSON(zmConfig.ZMSG_URL+"/inboxnotice",function(I){b("pm",x(I))})},3000)}else{b("pm",x(H))}})}function t(K){for(var J in K){var I=parseInt(K[J]),H=zm("#"+J+"counter");if(!I){H.hide();if(y!=-1){v()}}else{H.html(I.toString()).show();if(y==-1){a()}}E[J]=I}}function l(J,I){var H=zm.inArray(I,G);if(H!=-1){return}G.push(I);A.push(J)}function p(K){var L=zm.parseJSON(K);for(var J=0;J<L.length;J++){var M=L[J];for(var H=0;H<G.length;H++){if(A[H]==null||A[H]==M.type){try{G[H](M.type,M.data)}catch(I){}}}var N={};if(M.type=="notify2"){N.nt=M.data;t(N)}else{if(M.type=="notify.fr"){N.fr=M.data;t(N)}else{if(M.type=="notify.pm"){N.pm=M.data;t(N)}else{if(M.type=="new"){B()}}}}}}function s(I){var H=I!=j||j==null;j!=null&&w(j);H?i(I):w(I);if(zmNotifications.eShowingFeed){zm(zmNotifications.eShowingFeed).hideDisplaybox();zmNotifications.eShowingFeed=false}}function i(J){if(!J){return}j=J;var H=zm("#"+J+"btn");H.addClass("selected");zm("#"+J+"popup").parent().parent().show();H.focus();if(E[J]>0||zm("#"+J+"list").html()==""){var K={};K[J]=0;t(K);zm("#"+J+"list").html('<div class="notif_loading"></div>');try{if(J=="fr"){zmFriendRequests.getTopRequests(function(L){b(J,L)})}else{if(J=="pm"){loadmsg=0;k()}else{zm.post("/ntf2/content",{viewerId:zmConfig.viewerId,signkey:zmConfig.signkey,time:zmConfig.time,cate:"nt",fromid:0,count:9,type:1},{dataType:"json"},function(L){b(J,o(L.data));E[J]=0},function(){b(J,o({err:1}));E[J]=0})}}}catch(I){zm("#"+J+"list").html(h[J])}}}function w(H){if(H!=j||!H){return}j=null;zm("#"+H+"btn").removeClass("selected").removeClass("hover");zm("#"+H+"popup").parent().parent().hide()}function a(){if(y!=-1){clearInterval(y)}c=0;y=setInterval(d,3000)}function v(){clearInterval(y);y=-1;document.title=D}function d(){c++;if(c%2==0){document.title="Bạn có tin nhắn mới - "+D}else{document.title=D}}function F(){zm.post("/ntf2/counter",{viewerId:zmConfig.viewerId,signkey:zmConfig.signkey,time:zmConfig.time,type:2,cates:"nt,pm,fr"},{dataType:"json"},function(H){t(H)})}function r(){zm("#ntpreview").hide()}function f(H){}function B(){}function u(){if(this.initialized||zm("#ntbtn").size()<1){return}this.initialized=true;D=document.title;var J=["nt","fr","pm"],K=0;for(var I=0;I<J.length;I++){K+=zm("#"+J[I]+"btn").click(function(){var N=this.id,M=N.substr(0,2),L=N.substr(2);if(L=="counter"||L=="btn"){s(M)}}).hover(function(){zm(this).addClass("hover")},function(){zm(this).removeClass("hover")}).clickOutside(function(){w(j)},0,false,"zmcog.notifications").size()}zm("#emailbtn").click(function(){window.location.href="/apps/mail"}).mouseenter(function(){zm(this).addClass("hover")}).mouseleave(function(){zm(this).removeClass("hover")});if(K==0){return}var H=zm("#ntpreview");H.mouseenter(function(){if(g!=-1){clearTimeout(g);g=-1}}).mouseleave(function(){g=setTimeout(r,m)});if(!zm.isEmpty(zmNotifications.newCount)){t(zmNotifications.newCount)}else{setTimeout(F,1000)}H.click(function(L){var P="",M=false,N=this,O=window.location.toString();while(N!=null){if(N.nodeName=="A"){if(N.href!="#"&&N.href!=(O+"#")&&N.href!=O){P=N.href;M=true}else{r()}break}N=N.parentNode}if(!C){f(P);C=true}if(M){return false}})}this.fireNotify=p;this.notify=l;this.init=u;this.startAlert=a;this.resetAlert=v;this.toggle=s})();zm.ready(function(){setTimeout(function(){var a=zmNotifications.config;for(var b=0;b<a.servers.length;b++){var c=zm.createElement("iframe",{},{visibility:"hidden",position:"absolute",top:"0",left:"0",width:"0",height:"0"});try{c.src="http://"+a.servers[b]+"/subframe-"+a.frameVersion+".html#"+a.channel+"_"+a.sign+"_"+a.zmVersion;document.body.appendChild(c)}catch(c){}}},1000);zm(window).bind("message",function(d){var g=d.origin,f=zmNotifications.config.servers,a=false;for(var b=0,c;c=f[b];b++){if(g.indexOf(c)>-1){a=true;break}}a&&zmNotifications.fireNotify(d.data)})});